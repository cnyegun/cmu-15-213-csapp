#######################################################################
# Test for copying block of size 16;
#######################################################################
	.pos 0
main:	irmovq Stack, %rsp  	# Set up stack pointer

	# Set up arguments for copy function and then invoke it
	irmovq $16, %rdx		# src and dst have 16 elements
	irmovq dest, %rsi	# dst array
	irmovq src, %rdi	# src array
	call ncopy		 
	halt			# should halt with num nonzeros in %rax
StartFun:
##################################################################
# ncopy.ys - 8x unrolled with proper register saving
##################################################################
ncopy:
	# Save callee-saved registers
	pushq %rbx
	pushq %rbp
	
	xorq %rax,%rax
	andq %rdx,%rdx
	jle DonePop

Loop8:
    irmovq $8, %r9
    subq %r9, %rdx
    jl TailPrep
    
    # Load 8 elements
    mrmovq (%rdi), %r10
    mrmovq 8(%rdi), %r11
    mrmovq 16(%rdi), %r12
    mrmovq 24(%rdi), %r13
    mrmovq 32(%rdi), %r14
    mrmovq 40(%rdi), %rbx
    mrmovq 48(%rdi), %rcx
    mrmovq 56(%rdi), %rbp
    
    # Store all
    rmmovq %r10, (%rsi)
    rmmovq %r11, 8(%rsi)
    rmmovq %r12, 16(%rsi)
    rmmovq %r13, 24(%rsi)
    rmmovq %r14, 32(%rsi)
    rmmovq %rbx, 40(%rsi)
    rmmovq %rcx, 48(%rsi)
    rmmovq %rbp, 56(%rsi)
    
    # Check all 8
    andq %r10, %r10
    jle C2
    iaddq $1, %rax
C2: andq %r11, %r11
    jle C3
    iaddq $1, %rax
C3: andq %r12, %r12
    jle C4
    iaddq $1, %rax
C4: andq %r13, %r13
    jle C5
    iaddq $1, %rax
C5: andq %r14, %r14
    jle C6
    iaddq $1, %rax
C6: andq %rbx, %rbx
    jle C7
    iaddq $1, %rax
C7: andq %rcx, %rcx
    jle C8
    iaddq $1, %rax
C8: andq %rbp, %rbp
    jle U8
    iaddq $1, %rax
U8:
	iaddq $64, %rdi
	iaddq $64, %rsi
	jmp Loop8

TailPrep:
    iaddq $8, %rdx
    
Tail1:
    andq %rdx, %rdx
    jle DonePop
    mrmovq (%rdi), %r8
	rmmovq %r8, (%rsi)
    andq %r8, %r8
    jle Skip
	iaddq $1, %rax
Skip:
    iaddq $-1, %rdx
    iaddq $8, %rdi
    iaddq $8, %rsi
    jmp Tail1

DonePop:
	# Restore callee-saved registers
	popq %rbp
	popq %rbx

Done:
	ret
End:
EndFun:

###############################
# Source and destination blocks 
###############################
	.align 8
src:
	.quad -1
	.quad 2
	.quad 3
	.quad 4
	.quad 5
	.quad 6
	.quad 7
	.quad -8
	.quad 9
	.quad 10
	.quad -11
	.quad -12
	.quad -13
	.quad -14
	.quad -15
	.quad -16
	.quad 0xbcdefa # This shouldn't get moved

	.align 16
Predest:
	.quad 0xbcdefa
dest:
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
	.quad 0xcdefab
Postdest:
	.quad 0xdefabc

.align 8
# Run time stack
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0
	.quad 0

Stack:
